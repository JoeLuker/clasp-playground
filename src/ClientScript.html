<script>
  // --- UTILITY FUNCTIONS ---
  function showLoading(isLoading) {
    document.getElementById('process-day-btn').disabled = isLoading;
    document.getElementById('process-day-btn').textContent = isLoading ? 'Processing...' : 'Process Day';
  }

  function toggleSection(header) {
    const content = header.nextElementSibling;
    content.classList.toggle('active');
    header.textContent = header.textContent.replace('▼', '').replace('▶', '') + (content.classList.contains('active') ? ' ▼' : ' ▶');
  }

  // --- DATA DISPLAY FUNCTIONS ---
  function updateSidebar(data) {
    document.getElementById('current-day').textContent = data.currentDay;
    document.getElementById('total-miles').textContent = Math.round(data.totalMiles);
    document.getElementById('avg-hp').textContent = data.avgHp;
    document.getElementById('checks-needed').textContent = data.checksNeeded;
    document.getElementById('food-status').textContent = `${data.foodDays} days (${data.foodStatus})`;
    document.getElementById('water-status').textContent = `${data.waterDays} days (${data.waterStatus})`;
    
    // Update form values
    if (data.currentHex) document.getElementById('hex-coords').value = data.currentHex;
    if (data.hexTerrain) document.getElementById('hex-terrain').textContent = `Terrain: ${data.hexTerrain}`;
    if (data.temperature) document.getElementById('temperature-select').value = data.temperature;
    if (data.terrain) document.getElementById('terrain-select').value = data.terrain;
    if (data.pathType) document.getElementById('path-type-select').value = data.pathType;
    if (data.weather) document.getElementById('weather-select').value = data.weather;
    if (data.travelPace) document.getElementById('pace-select').value = data.travelPace;
    if (data.animalsGrazing !== undefined) document.getElementById('animals-grazing').checked = data.animalsGrazing;
    
    const alertBox = document.getElementById('alert-box');
    if (data.alertText && data.alertText.trim() !== '') {
      alertBox.textContent = data.alertText;
      alertBox.classList.remove('no-alert');
    } else {
      alertBox.textContent = 'All systems normal.';
      alertBox.classList.add('no-alert');
    }
  }

  // --- SERVER CALL HANDLERS ---
  function showNotification(message, isError = false) {
    const alertBox = document.getElementById('alert-box');
    if (alertBox) {
      alertBox.textContent = message;
      alertBox.classList.remove('no-alert');
      if (isError) {
        alertBox.style.backgroundColor = '#c0392b';
      }
      // Auto-clear after 5 seconds for non-critical messages
      if (!isError) {
        setTimeout(() => {
          if (alertBox.textContent === message) {
            alertBox.textContent = 'All systems normal.';
            alertBox.classList.add('no-alert');
          }
        }, 5000);
      }
    } else {
      // Fallback to alert if alert box not found
      alert(message);
    }
  }

  function onProcessDaySuccess(message) {
    // Show success notification instead of blocking alert
    showNotification(message, false);
    fetchData();
  }

  function onPreviewDaySuccess(preview) {
    const message = `Preview: ${preview.miles} miles, Food: -${preview.food}, Water: -${preview.water}, Fodder: -${preview.fodder}, Provisions: -${preview.provisions}`;
    showNotification(message, false);
    showLoading(false); // Re-enable buttons after preview
  }

  let retryCount = 0;
  const MAX_RETRIES = 2;
  
  function onFailure(error, retryFunction = null) {
    retryCount++;
    const errorMessage = error.message || 'An unknown error occurred';
    
    // Retry transient errors (network issues, quota exceeded temporarily)
    if (retryCount <= MAX_RETRIES && retryFunction && 
        (errorMessage.includes('timeout') || errorMessage.includes('quota') || errorMessage.includes('network'))) {
      showNotification(`Error: ${errorMessage}. Retrying... (${retryCount}/${MAX_RETRIES})`, true);
      setTimeout(() => {
        retryFunction();
      }, 1000 * retryCount); // Exponential backoff
      return;
    }
    
    // Show error notification
    showNotification(`Error: ${errorMessage}`, true);
    showLoading(false);
    retryCount = 0; // Reset retry count
  }
  
  // --- MAIN DATA FETCH FUNCTION ---
  function fetchData() {
    showLoading(true);
    retryCount = 0; // Reset retry count for new operation
    google.script.run
      .withSuccessHandler(function(data) {
        retryCount = 0; // Reset on success
        updateSidebar(data);
        showLoading(false);
      })
      .withFailureHandler(function(error) {
        onFailure(error, fetchData);
      })
      .getDashboardData();
  }

  // --- EVENT LISTENERS ---
  document.addEventListener('DOMContentLoaded', function() {
    // Initial data load when the sidebar opens
    fetchData();

    // Attach click handlers to buttons
    document.getElementById('process-day-btn').addEventListener('click', function() {
      showLoading(true);
      retryCount = 0;
      google.script.run
        .withSuccessHandler(function(message) {
          retryCount = 0;
          onProcessDaySuccess(message);
          showLoading(false);
        })
        .withFailureHandler(function(error) {
          onFailure(error, function() {
            document.getElementById('process-day-btn').click();
          });
        })
        .processDay();
    });

    document.getElementById('preview-day-btn').addEventListener('click', function() {
      showLoading(true);
      retryCount = 0;
      google.script.run
        .withSuccessHandler(function(preview) {
          retryCount = 0;
          onPreviewDaySuccess(preview);
        })
        .withFailureHandler(function(error) {
          onFailure(error, function() {
            document.getElementById('preview-day-btn').click();
          });
        })
        .previewDay();
    });
    
    document.getElementById('refresh-btn').addEventListener('click', fetchData);
    
    // Update resources button
    document.getElementById('update-resources-btn').addEventListener('click', function() {
      const foodFound = parseFloat(document.getElementById('food-found').value) || 0;
      const waterFound = parseFloat(document.getElementById('water-found').value) || 0;
      
      if (foodFound === 0 && waterFound === 0) {
        showNotification('Please enter at least one resource value.', true);
        return;
      }
      
      google.script.run
        .withSuccessHandler(function() {
          document.getElementById('food-found').value = '';
          document.getElementById('water-found').value = '';
          fetchData();
          showNotification('Resources updated!', false);
        })
        .withFailureHandler(function(error) {
          onFailure(error);
        })
        .updateResourcesFound(foodFound, waterFound);
    });
    
    // Update environment button
    document.getElementById('update-environment-btn').addEventListener('click', function() {
      const environment = {
        temperature: document.getElementById('temperature-select').value,
        terrain: document.getElementById('terrain-select').value,
        pathType: document.getElementById('path-type-select').value,
        weather: document.getElementById('weather-select').value,
        travelPace: document.getElementById('pace-select').value,
        animalsGrazing: document.getElementById('animals-grazing').checked
      };
      
      google.script.run
        .withSuccessHandler(function() {
          fetchData();
          showNotification('Environment updated!', false);
        })
        .withFailureHandler(function(error) {
          onFailure(error);
        })
        .updateEnvironment(environment);
    });
    
    // Set hex location button
    document.getElementById('set-hex-btn').addEventListener('click', function() {
      const hexCoords = document.getElementById('hex-coords').value.trim();
      if (!hexCoords) {
        showNotification('Please enter hex coordinates (format: q:r:s)', true);
        return;
      }
      
      if (!/^-?\d+:-?\d+:-?\d+$/.test(hexCoords)) {
        showNotification('Invalid format. Use q:r:s (e.g., 0:0:0)', true);
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(result) {
          fetchData();
          showNotification(result, false);
        })
        .withFailureHandler(function(error) {
          onFailure(error);
        })
        .setCurrentHex(hexCoords);
    });
  });
</script>

